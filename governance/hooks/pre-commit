#!/bin/bash
# MEMOLA Governance Council — Pre-Commit Hook
# Install: cp pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

echo ""
echo "╔════════════════════════════════════════════╗"
echo "║     MEMOLA GOVERNANCE COUNCIL              ║"
echo "║     Pre-Commit Security Review             ║"
echo "╚════════════════════════════════════════════╝"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

VETO=0
WARNINGS=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No files staged for commit."
    exit 0
fi

echo "Files to review:"
echo "$STAGED_FILES"
echo ""

# ═══════════════════════════════════════════════════════════════
# CENTINELA: Security Patterns
# ═══════════════════════════════════════════════════════════════

echo "CENTINELA scanning..."

# Critical patterns (hard block)
CRITICAL_PATTERNS=(
    "xkeysib-[a-f0-9]"
    "sk-[a-zA-Z0-9]{20,}"
    "sk_live_"
    "pk_live_"
    "AKIA[A-Z0-9]{16}"
    "ghp_[a-zA-Z0-9]{36}"
    "BEGIN.*PRIVATE KEY"
    "mongodb.*://.*:.*@"
    "postgres.*://.*:.*@"
)

for pattern in "${CRITICAL_PATTERNS[@]}"; do
    MATCHES=$(echo "$STAGED_FILES" | xargs grep -lE "$pattern" 2>/dev/null || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}[CRITICAL]${NC} Secret pattern detected: $pattern"
        echo "  Files: $MATCHES"
        VETO=1
    fi
done

# Warning patterns (soft block)
WARNING_PATTERNS=(
    "@gmail\."
    "@hotmail\."
    "@yahoo\."
    "C:\\\\Users\\\\"
    "/home/[a-zA-Z]"
    "/Users/[a-zA-Z]"
    "password\s*=\s*[\"'][^\"']+"
    "api_key\s*=\s*[\"'][^\"']+"
)

for pattern in "${WARNING_PATTERNS[@]}"; do
    MATCHES=$(echo "$STAGED_FILES" | xargs grep -lE "$pattern" 2>/dev/null || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${YELLOW}[WARNING]${NC} Potential sensitive pattern: $pattern"
        echo "  Files: $MATCHES"
        ((WARNINGS++))
    fi
done

if [ $VETO -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}CENTINELA: APPROVE${NC} — No sensitive patterns detected"
else
    echo ""
fi

# ═══════════════════════════════════════════════════════════════
# Council Decision
# ═══════════════════════════════════════════════════════════════

echo ""
echo "═══════════════════════════════════════════════════════════"

if [ $VETO -eq 1 ]; then
    echo -e "${RED}COUNCIL DECISION: VETO${NC}"
    echo ""
    echo "Critical security issue detected."
    echo "Cannot proceed without remediation."
    echo ""
    echo "To review staged changes: git diff --cached"
    echo "To unstage: git reset HEAD <file>"
    echo ""
    exit 1
fi

if [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}COUNCIL: $WARNINGS warning(s) detected${NC}"
    echo ""
    echo "Manual review required for:"
    echo "  MEMOR:  Does this align with strategy?"
    echo "  VIGIL:  Any client/revenue data exposed?"
    echo "  NEXO:   Any operational secrets?"
    echo "  PULSO:  Any intelligence leaked?"
    echo ""
    read -p "All council members approve? (y/n): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}COUNCIL: BLOCKED${NC} — Commit aborted"
        exit 1
    fi
fi

echo -e "${GREEN}COUNCIL: UNANIMOUS APPROVAL${NC}"
echo "Proceeding with commit..."
echo ""

exit 0
